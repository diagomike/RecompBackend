# **Technical Specification: Module Registry Component**

**Version:** 1.0.0

**Component:** Task Runner Core / Module Registry

## **1\. Overview**

The Module Registry is the foundational component of the Task Runner. It is responsible for the discovery, isolation, installation, verification, and registration of independent Python compute modules.

It ensures that the Task Runner Host remains decoupled from the specific dependencies of the worker modules by utilizing a **CLI-based subprocess architecture** where each module runs in its own dedicated Virtual Environment.

## **2\. Directory Structure**

The system enforces a strict directory structure. The Host scans the modules/ directory. Every subdirectory is treated as a potential candidate for registration.

/task-runner-root/  
├── core/  
│   ├── registry/           \# Registry Logic  
│   └── database/           \# MongoDB Connectors  
├── modules/                \# The Plugin Folder  
│   ├── face-detection-v1/  \# INDEPENDENT MODULE A  
│   │   ├── venv/           \# Auto-generated by Registry (Isolated Env)  
│   │   ├── module.json     \# The Metadata Contract  
│   │   ├── main.py         \# The CLI Entry Point  
│   │   ├── requirements.txt\# Dependencies (tensorflow, opencv, etc.)  
│   │   └── test\_data.json  \# Mandatory test payload  
│   └── audio-transcribe/   \# INDEPENDENT MODULE B  
│       ├── venv/  
│       ├── ...  
│       └── ...  
└── logs/                   \# Centralized logs for installation/runtime

## **3\. The Module Interface (The Contract)**

For a folder to be recognized as a valid module, it must contain a module.json and a main.py.

### **3.1 Metadata: module.json**

This file defines the module's identity and capabilities.

{  
  "name": "face-detection-v1",  
  "version": "1.0.0",  
  "description": "Detects faces in video files.",  
  "entry\_point": "main.py",  
  "requirements\_file": "requirements.txt",  
  "inputs": \[  
    { "key": "video\_file", "type": "file\_path", "format": "mp4" }  
  \],  
  "outputs": \[  
    { "key": "face\_coordinates", "type": "json\_data" },  
    { "key": "thumbnail", "type": "file\_path" }  
  \],  
  "timeout\_seconds": 300  
}

### **3.2 CLI Interface: main.py**

The Module Registry interacts with modules **exclusively** via Command Line Arguments. The main.py of every module must handle the following flags:

| Mode Flag | Argument | Description |
| :---- | :---- | :---- |
| \--mode setup | N/A | **(Optional)** Perform any internal setup (e.g., downloading weights) after pip install. |
| \--mode test | \--input\_file \<path\> | Runs the module with the test\_data.json. Must print {"status": "success", ...} to stdout on success. |
| \--mode run | \--task\_id \<id\> \--input\_file \<path\> | Performs the actual heavy-duty processing. Writes results to stdout or a specified output file. |

**Standard Output (STDOUT) Protocol:**

* **Logs:** Any text printed is captured as logs.  
* **Result:** The final line of output (or a specific JSON block) is parsed as the result.

## **4\. Database Schema (MongoDB)**

The Registry acts as the source of truth. The API queries this collection to see what is available.

**Collection:** module\_registry

{  
  "\_id": "face-detection-v1",        // Unique Module Name  
  "status": "AVAILABLE",             // Enum: DETECTED, INSTALLING, TESTING, AVAILABLE, ERROR, DISABLED  
  "path": "/abs/path/to/modules/face-detection-v1",  
  "venv\_path": "/abs/path/to/modules/face-detection-v1/venv",  
  "python\_exec": "/abs/path/to/modules/face-detection-v1/venv/bin/python",  
  "version": "1.0.0",  
  "config": { ... },                 // Copy of module.json  
  "capabilities": {                  // For filtering in the API  
    "accepts": \["mp4"\],  
    "returns": \["json", "jpg"\]  
  },  
  "health\_check": {  
    "last\_tested": "2023-10-27T10:00:00Z",  
    "passed": true  
  },  
  "installation\_logs": \[             // captured stdout/stderr during pip install  
    "Collecting tensorflow...",  
    "Successfully installed..."  
  \],  
  "created\_at": "ISO-Date",  
  "updated\_at": "ISO-Date"  
}

## **5\. Operational Workflow (The Lifecycle)**

The ModuleRegistry class manages the lifecycle state machine.

### **Phase 1: Detection**

1. **Scanner:** Iterates through /modules/.  
2. **Hash Check:** Calculates a hash of the folder contents.  
3. **DB Lookup:** Checks if the module exists in MongoDB.  
   * If New \-\> Create Record (Status: DETECTED).  
   * If Changed (Hash mismatch) \-\> Update Record (Status: DETECTED).  
   * If Unchanged \-\> Skip.

### **Phase 2: Installation (The Builder)**

*Triggered automatically if status is DETECTED.*

1. **Environment Setup:**  
   * Command: python \-m venv \<module\_path\>/venv  
2. **Dependency Installation:**  
   * Command: \<venv\_python\> \-m pip install \-r requirements.txt  
3. **Logging:** Streams stdout/stderr to the installation\_logs field in MongoDB.  
4. **Transition:**  
   * Success \-\> Update Status to TESTING.  
   * Failure \-\> Update Status to ERROR.

### **Phase 3: Verification (The Gatekeeper)**

*Triggered automatically if status is TESTING.*

1. **Execution:**  
   * Command: \<venv\_python\> main.py \--mode test \--input test\_data.json  
2. **Validation:**  
   * Registry checks exit code (must be 0).  
   * Registry checks stdout for specific success key.  
3. **Transition:**  
   * Success \-\> Update Status to AVAILABLE.  
   * Failure \-\> Update Status to ERROR (Module is quarantined).

## **6\. Architecture Class Design**

### **ModuleScanner**

* **Responsibility:** filesystem operations, hashing, module.json validation.  
* **Methods:** scan\_directory(), validate\_schema().

### **EnvironmentManager**

* **Responsibility:** venv creation, pip execution.  
* **Methods:** create\_venv(path), install\_requirements(path).

### **ModuleRunner (Base Class for Registry & Task Queue)**

* **Responsibility:** Abstracting the subprocess calls.  
* **Methods:** execute\_module(module\_id, mode, args).  
* **Note:** Uses the database to look up the python\_exec path for the specific module.

### **RegistryOrchestrator**

* **Responsibility:** High-level logic tying Scanner, Manager, and Runner together. Updates MongoDB status.

## **7\. Error Handling & Logging**

* **Isolation:** If a module crashes during install/test, the main Task Runner process **must not** crash. All subprocess calls must be wrapped in try/except blocks with timeouts.  
* **Persistance:** All errors are written to the logs array in the MongoDB document for that module, allowing the Frontend Dashboard to display *exactly* why a module failed to load (e.g., "Missing library libGL.so").

